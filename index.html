<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ReelMind 後台管理系統</title>
    <link rel="stylesheet" href="styles.css">
    <style>
      /* 禁用雙擊縮放 */
      * {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }
      
      /* 禁用文字選擇 */
      body {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      
      /* 允許輸入框可選擇文字 */
      input, textarea, select {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
    </style>
  </head>
<body>
    <div class="dashboard-container">
        <!-- 側邊欄 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>🎬 ReelMind</h2>
                <p>後台管理系統</p>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-section="overview">
                    <span class="icon">📊</span>
                    <span>數據概覽</span>
                </a>
                <a href="#" class="nav-item" data-section="users">
                    <span class="icon">👥</span>
                    <span>用戶管理</span>
                </a>
                <a href="#" class="nav-item" data-section="modes">
                    <span class="icon">🎯</span>
                    <span>模式分析</span>
                </a>
                <a href="#" class="nav-item" data-section="conversations">
                    <span class="icon">💬</span>
                    <span>對話記錄</span>
                </a>
                <a href="#" class="nav-item" data-section="long-term-memory">
                    <span class="icon">🧠</span>
                    <span>長期記憶</span>
                </a>
                <a href="#" class="nav-item" data-section="scripts">
                    <span class="icon">📝</span>
                    <span>腳本管理</span>
                </a>
                <a href="#" class="nav-item" data-section="ip-planning">
                    <span class="icon">🎭</span>
                    <span>IP人設規劃</span>
                </a>
                <a href="#" class="nav-item" data-section="orders">
                    <span class="icon">💳</span>
                    <span>購買記錄</span>
                </a>
                <a href="#" class="nav-item" data-section="license-activations">
                    <span class="icon">🔗</span>
                    <span>授權記錄</span>
                </a>
                <a href="#" class="nav-item" data-section="generations" style="display: none;">
                    <span class="icon">✨</span>
                    <span>生成記錄</span>
                </a>
                <a href="#" class="nav-item" data-section="analytics">
                    <span class="icon">📈</span>
                    <span>數據分析</span>
                </a>
                <a href="#" class="nav-item" data-section="admin-settings">
                    <span class="icon">⚙️</span>
                    <span>管理員設定</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">
                    <span class="icon">🚪</span>
                    <span>登出</span>
                </button>
            </div>
        </div>

        <!-- 主內容區 -->
        <div class="main-content">
            <!-- 頂部導航 -->
            <header class="top-header">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
                <h1 id="page-title">數據概覽</h1>
                <div class="header-actions">
                    <button class="btn-refresh" onclick="refreshData()">🔄 重新整理</button>
                    <div class="time-display" id="current-time"></div>
                </div>
            </header>

            <!-- 數據概覽頁面 -->
            <div class="section active" id="overview">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">👥</div>
                        <div class="stat-info">
                            <h3 id="total-users">-</h3>
                            <p>總用戶數</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💬</div>
                        <div class="stat-info">
                            <h3 id="total-conversations">-</h3>
                            <p>對話總數</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📝</div>
                        <div class="stat-info">
                            <h3 id="total-scripts">-</h3>
                            <p>生成腳本</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🎯</div>
                        <div class="stat-info">
                            <h3 id="total-positioning">-</h3>
                            <p>帳號定位</p>
                        </div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <h3>用戶增長趨勢</h3>
                        <canvas id="user-growth-chart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>模式使用分布</h3>
                        <canvas id="mode-distribution-chart"></canvas>
                    </div>
                </div>

                <div class="recent-activity">
                    <h3>最近活動</h3>
                    <div class="activity-list" id="recent-activities"></div>
                </div>
            </div>

            <!-- 用戶管理頁面 -->
            <div class="section" id="users">
                <div class="section-header">
                    <h2>用戶管理</h2>
                    <div class="filters">
                        <input type="text" id="user-search" placeholder="搜尋用戶..." onkeyup="filterUsers()">
                        <select id="user-filter-platform" onchange="filterUsers()">
                            <option value="">所有平台</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="users-table">
                        <thead>
                            <tr>
                                <th>用戶ID</th>
                                <th>Email</th>
                                <th>姓名</th>
                                <th>訂閱狀態</th>
                                <th>註冊時間</th>
                                <th>對話數</th>
                                <th>腳本數</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- 模式分析頁面 -->
            <div class="section" id="modes">
                <div class="mode-stats">
                    <div class="mode-card">
                        <h3>🎯 一鍵生成模式</h3>
                        <div class="mode-stats-grid">
                            <div class="mode-stat">
                                <span class="label">使用次數</span>
                                <span class="value" id="mode1-count">-</span>
                            </div>
                            <div class="mode-stat">
                                <span class="label">完成率</span>
                                <span class="value" id="mode1-completion">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="mode-card">
                        <h3>💬 AI顧問模式</h3>
                        <div class="mode-stats-grid">
                            <div class="mode-stat">
                                <span class="label">對話數</span>
                                <span class="value" id="mode2-count">-</span>
                            </div>
                            <div class="mode-stat">
                                <span class="label">平均對話輪數</span>
                                <span class="value" id="mode2-avg">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="mode-card">
                        <h3>🎭 IP人設規劃模式</h3>
                        <div class="mode-stats-grid">
                            <div class="mode-stat">
                                <span class="label">使用次數</span>
                                <span class="value" id="mode3-count">-</span>
                            </div>
                            <div class="mode-stat">
                                <span class="label">生成Profile</span>
                                <span class="value" id="mode3-profile">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>模式使用時間分布</h3>
                    <canvas id="mode-time-chart"></canvas>
                </div>
            </div>

            <!-- 對話記錄頁面 -->
            <div class="section" id="conversations">
                <div class="section-header">
                    <h2>對話記錄</h2>
                    <select id="conversation-filter" onchange="loadConversations()">
                        <option value="all">所有對話</option>
                        <option value="mode2">AI顧問模式</option>
                        <option value="mode3">IP人設規劃模式</option>
                    </select>
                </div>
                <div class="table-container">
                    <table class="data-table" id="conversations-table">
                        <thead>
                            <tr>
                                <th>用戶ID</th>
                                <th>模式</th>
                                <th>對話摘要</th>
                                <th>消息數</th>
                                <th>時間</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="conversations-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- 長期記憶頁面 -->
            <div class="section" id="long-term-memory">
                <div class="section-header">
                    <h2>長期記憶管理</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">🧠</div>
                        <div class="stat-info">
                            <h3 id="total-memories">-</h3>
                            <p>總記憶數</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">👥</div>
                        <div class="stat-info">
                            <h3 id="active-users-memory">-</h3>
                            <p>活躍用戶</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💬</div>
                        <div class="stat-info">
                            <h3 id="today-memories">-</h3>
                            <p>今日新增</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-info">
                            <h3 id="avg-memories-per-user">-</h3>
                            <p>平均記憶/用戶</p>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="memory-table">
                        <thead>
                            <tr>
                                <th>用戶</th>
                                <th>用戶ID</th>
                                <th>記憶數</th>
                                <th>會話數</th>
                                <th>對話類型</th>
                                <th>時間範圍</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="memory-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- 腳本管理頁面 -->
            <div class="section" id="scripts">
                <div class="section-header">
                    <h2>腳本管理</h2>
                    <div class="filters">
                        <select id="script-filter-user" onchange="loadScripts()">
                            <option value="">所有用戶</option>
                        </select>
                        <select id="script-filter-platform" onchange="loadScripts()">
                            <option value="">所有平台</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="scripts-table">
                        <thead>
                            <tr>
                                <th>腳本ID</th>
                                <th>用戶</th>
                                <th>標題</th>
                                <th>平台</th>
                                <th>主題</th>
                                <th>創建時間</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="scripts-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- IP人設規劃管理頁面 -->
            <div class="section" id="ip-planning">
                <div class="section-header">
                    <h2>IP人設規劃管理</h2>
                    <div class="filters">
                        <select id="ip-planning-filter-type" onchange="loadIpPlanningResults()">
                            <option value="">所有類型</option>
                            <option value="profile">IP Profile</option>
                            <option value="plan">14天規劃</option>
                            <option value="scripts">今日腳本</option>
                        </select>
                        <select id="ip-planning-filter-user" onchange="loadIpPlanningResults()">
                            <option value="">所有用戶</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="ip-planning-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用戶</th>
                                <th>類型</th>
                                <th>標題</th>
                                <th>內容預覽</th>
                                <th>創建時間</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="ip-planning-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- 購買記錄頁面 -->
            <div class="section" id="orders">
                <div class="section-header">
                    <h2>購買記錄</h2>
                    <button class="btn-export" onclick="exportCSV('orders')">📥 匯出 CSV</button>
                </div>
                <div class="stats-grid" style="margin-bottom: 20px;"></div>
                <div class="table-container"></div>
            </div>

            <!-- 授權記錄頁面 -->
            <div class="section" id="license-activations">
                <div class="section-header">
                    <h2>授權記錄</h2>
                    <div class="filters">
                        <select id="activation-filter-status" onchange="loadLicenseActivations()">
                            <option value="">所有狀態</option>
                            <option value="pending">待啟用</option>
                            <option value="activated">已啟用</option>
                            <option value="expired">已過期</option>
                        </select>
                        <select id="activation-filter-channel" onchange="loadLicenseActivations()">
                            <option value="">所有通路</option>
                            <option value="portaly">Portaly</option>
                            <option value="ppa">PPA</option>
                            <option value="ecpay">官網購買</option>
                        </select>
                    </div>
                </div>
                <div class="table-container"></div>
            </div>

            <!-- 生成記錄頁面（已隱藏） -->
            <div class="section" id="generations" style="display: none;">
                <div class="section-header">
                    <h2>生成記錄</h2>
                </div>
                <div class="table-container">
                    <table class="data-table" id="generations-table">
                        <thead>
                            <tr>
                                <th>生成ID</th>
                                <th>用戶</th>
                                <th>平台</th>
                                <th>主題</th>
                                <th>類型</th>
                                <th>時間</th>
                            </tr>
                        </thead>
                        <tbody id="generations-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- 管理員設定頁面 -->
            <div class="section" id="admin-settings">
                <div class="section-header">
                    <h2>管理員設定</h2>
                </div>
                <div class="settings-container" style="padding: 2rem;">
                    <!-- 資料匯出區塊 -->
                    <div class="settings-card" style="background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 16px 0; color: #1e293b;">📥 資料匯出</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">匯出所有後台管理系統的資料為 CSV 檔案</p>
                        <div class="export-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <button class="btn btn-secondary" onclick="exportAllData('users')">
                                <i class="icon">👥</i> 匯出用戶資料
                            </button>
                            <button class="btn btn-secondary" onclick="exportAllData('conversations')">
                                <i class="icon">💬</i> 匯出對話記錄
                            </button>
                            <button class="btn btn-secondary" onclick="exportAllData('scripts')">
                                <i class="icon">📝</i> 匯出腳本資料
                            </button>
                            <button class="btn btn-secondary" onclick="exportAllData('orders')">
                                <i class="icon">💳</i> 匯出購買記錄
                            </button>
                            <button class="btn btn-secondary" onclick="exportAllData('long-term-memory')">
                                <i class="icon">🧠</i> 匯出長期記憶
                            </button>
                            <button class="btn btn-secondary" onclick="exportAllData('generations')">
                                <i class="icon">✨</i> 匯出生成記錄
                            </button>
                            <button class="btn btn-primary" onclick="exportAllData('full-backup')" style="grid-column: 1 / -1;">
                                <i class="icon">📦</i> 匯出完整備份（所有資料）
                            </button>
                        </div>
                    </div>
                    
                    <!-- 資料匯入區塊 -->
                    <div class="settings-card" style="background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin: 0 0 16px 0; color: #1e293b;">📤 資料匯入</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">從 CSV 檔案匯入資料</p>
                        <div class="import-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                            <label style="display: flex; flex-direction: column; gap: 8px;">
                                <span style="font-weight: 600; color: #374151;">匯入類型</span>
                                <select id="import-type" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="users">用戶資料</option>
                                    <option value="scripts">腳本資料</option>
                                    <option value="conversations">對話記錄</option>
                                    <option value="orders">購買記錄</option>
                                </select>
                            </label>
                            <label style="display: flex; flex-direction: column; gap: 8px;">
                                <span style="font-weight: 600; color: #374151;">匯入模式</span>
                                <select id="import-mode" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="add">新增模式（跳過重複）</option>
                                    <option value="replace">覆蓋模式（更新現有）</option>
                                </select>
                            </label>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">選擇 CSV 檔案</label>
                            <input type="file" id="import-file" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                            <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">
                                <i class="icon">📁</i> 選擇檔案
                            </button>
                            <span id="import-file-name" style="margin-left: 12px; color: #64748b;"></span>
                        </div>
                        <button class="btn btn-primary" onclick="importData()" id="import-btn" disabled>
                            <i class="icon">📤</i> 開始匯入
                        </button>
                        <div id="import-progress" style="margin-top: 16px; display: none;">
                            <div style="background: #f3f4f6; border-radius: 4px; height: 8px; overflow: hidden;">
                                <div id="import-progress-bar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <p id="import-status" style="margin-top: 8px; color: #64748b; font-size: 0.9em;"></p>
                        </div>
                    </div>
                    
                    <!-- 系統資訊區塊 -->
                    <div class="settings-card" style="background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 24px;">
                        <h3 style="margin: 0 0 16px 0; color: #1e293b;">ℹ️ 系統資訊</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div>
                                <span style="color: #64748b; font-size: 0.9em;">當前管理員</span>
                                <p style="margin: 4px 0 0 0; font-weight: 600; color: #1e293b;" id="current-admin-name">載入中...</p>
                            </div>
                            <div>
                                <span style="color: #64748b; font-size: 0.9em;">登入時間</span>
                                <p style="margin: 4px 0 0 0; font-weight: 600; color: #1e293b;" id="login-time">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 數據分析頁面 -->
            <div class="section" id="analytics">
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>平台使用分布</h3>
                        <canvas id="platform-chart"></canvas>
                    </div>
                    <div class="analytics-card">
                        <h3>時間段使用分析</h3>
                        <canvas id="time-usage-chart"></canvas>
                    </div>
                    <div class="analytics-card">
                        <h3>用戶活躍度</h3>
                        <canvas id="activity-chart"></canvas>
                    </div>
                    <div class="analytics-card">
                        <h3>內容類型分布</h3>
                        <canvas id="content-type-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 對話詳情彈窗 -->
    <div class="modal" id="conversation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>對話詳情</h3>
                <button class="modal-close" onclick="closeModal('conversation-modal')">✕</button>
            </div>
            <div class="modal-body" id="conversation-detail-content">
                <!-- 對話內容將在這裡載入 -->
            </div>
        </div>
    </div>

    <!-- 腳本詳情彈窗 -->
    <div class="modal" id="script-modal" onclick="handleModalClick(event, 'script-modal')">
        <div class="modal-content" style="max-width: 800px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>腳本詳情</h3>
                <button class="modal-close" onclick="closeModal('script-modal')">✕</button>
            </div>
            <div class="modal-body" id="script-detail-content">
                <!-- 腳本內容將在這裡載入 -->
            </div>
        </div>
    </div>

    <!-- 訂閱設置彈窗 -->
    <div class="modal" id="subscription-modal" onclick="handleModalClick(event, 'subscription-modal')">
        <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>啟用訂閱</h3>
                <button class="modal-close" onclick="closeModal('subscription-modal')">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">訂閱期限</label>
                    <div style="display: flex; gap: 12px;">
                        <label id="subscription-monthly-label" style="flex: 1; display: flex; align-items: center; padding: 12px; border: 2px solid #3b82f6; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: #eff6ff;" 
                               onclick="document.querySelector('input[name=\"subscription-period\"][value=\"monthly\"]').click();"
                               onmouseover="if(!document.querySelector('input[name=\"subscription-period\"][value=\"monthly\"]').checked) this.style.borderColor='#3b82f6'; this.style.backgroundColor='#eff6ff';" 
                               onmouseout="if(!document.querySelector('input[name=\"subscription-period\"][value=\"monthly\"]').checked) { this.style.borderColor='#e5e7eb'; this.style.backgroundColor='transparent'; }">
                            <input type="radio" name="subscription-period" value="monthly" checked style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;" 
                                   onchange="updateSubscriptionPeriod(this.value)">
                            <div>
                                <div style="font-weight: 600; color: #1f2937;">月費</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">30 天</div>
                            </div>
                        </label>
                        <label id="subscription-yearly-label" style="flex: 1; display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                               onclick="document.querySelector('input[name=\"subscription-period\"][value=\"yearly\"]').click();"
                               onmouseover="if(!document.querySelector('input[name=\"subscription-period\"][value=\"yearly\"]').checked) this.style.borderColor='#3b82f6'; this.style.backgroundColor='#eff6ff';" 
                               onmouseout="if(!document.querySelector('input[name=\"subscription-period\"][value=\"yearly\"]').checked) { this.style.borderColor='#e5e7eb'; this.style.backgroundColor='transparent'; }">
                            <input type="radio" name="subscription-period" value="yearly" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;" 
                                   onchange="updateSubscriptionPeriod(this.value)">
                            <div>
                                <div style="font-weight: 600; color: #1f2937;">年費</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">365 天</div>
                            </div>
                        </label>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">備註原因 <span style="color: #9ca3af; font-weight: 400;">(選填)</span></label>
                    <textarea id="subscription-note" 
                              placeholder="請輸入啟用訂閱的原因，例如：測試帳號、特殊優惠、補償用戶等..."
                              style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeModal('subscription-modal')" 
                            style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        取消
                    </button>
                    <button onclick="confirmSubscription()" 
                            style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        確認啟用
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="app.js"></script>
</body>
</html>
